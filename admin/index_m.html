<html>

<head>

    <!-- Load ioBroker scripts and styles-->
    <link rel="stylesheet" type="text/css" href="../../css/adapter.css" />
    <link rel="stylesheet" type="text/css" href="../../lib/css/materialize.css">

    <script type="text/javascript" src="../../lib/js/jquery-3.2.1.min.js"></script>
    <script type="text/javascript" src="../../socket.io/socket.io.js"></script>

    <script type="text/javascript" src="../../js/translate.js"></script>
    <script type="text/javascript" src="../../lib/js/materialize.js"></script>
    <script type="text/javascript" src="../../js/adapter-settings.js"></script>

    <!-- Load our own files -->
    <link rel="stylesheet" type="text/css" href="style.css" />
    <script type="text/javascript" src="words.js"></script>

    <script type="text/javascript">
        // This will be called by the admin adapter when the settings page loads
        let globalBlacklist = [];   // For table "globalBlacklist"
        let parserRules = [];   // For table "parserRules"
        function load(settings, onChange) {
            // example: select elements with id=key and class=value and insert value
            if (!settings) return;
            $('.value').each(function () {
                var $key = $(this);
                var id = $key.attr('id');
                if ($key.attr('type') === 'checkbox') {
                    // do not call onChange direct, because onChange could expect some arguments
                    $key.prop('checked', settings[id])
                        .on('change', () => onChange())
                        ;
                } else {
                    // do not call onChange direct, because onChange could expect some arguments
                    $key.val(settings[id])
                        .on('change', () => onChange())
                        .on('keyup', () => onChange())
                        ;
                }
            });
            globalBlacklist = settings.globalBlacklist || [];   // For table "globalBlacklist"
            parserRules = settings.parserRules || [];   // For table "parserRules"
            onChange(false);
            values2table('globalBlacklist', globalBlacklist, onChange);   // For table "globalBlacklist"
            values2table('parserRules', parserRules, onChange);   // For table "parserRules"
            // reinitialize all the Materialize labels on the page if you are dynamically adding inputs:
            if (M) M.updateTextFields();
        }

        // This will be called by the admin adapter when the user presses the save button
        function save(callback) {
            // example: select elements with class=value and build settings object
            var obj = {};
            $('.value').each(function () {
                var $this = $(this);
                if ($this.attr('type') === 'checkbox') {
                    obj[$this.attr('id')] = $this.prop('checked');
                } else {
                    obj[$this.attr('id')] = $this.val();
                }
            });
            obj.globalBlacklist = table2values('globalBlacklist');    // For table "globalBlacklist"
            obj.parserRules = table2values('parserRules');    // For table "parserRules"
            callback(obj);
        }
    </script>

    <style>
        /* Title of each section */
        .title { font-weight: bold; }
        /* Info text of each section */
        .info { margin-left: 1em; }
        /* Table header */
        .table-values th { height: 2em; background-color:#2196F3; font-size:90%; }
        /* Table: Add button */
        .table-button-add { margin: 0.3em 0 1em 0; }
        /* Intro */
        .intro {font-size: 16px;}
        .intro p {margin-bottom: 0.5em !important; padding-bottom: 0 !important;}
        .intro ul { margin-top: 0 !important }
        .intro li { list-style: disc outside none !important;  display: list-item !important; margin-left: 2em !important; margin-bottom: 0.5em !important; }
    </style>

</head>

<body>

    <div class="m adapter-container">

        <div class="row">

            <!-- Define all Tabs -->
            <div class="col s12">
                <ul class="tabs">
                    <li class="tab col s3"><a href="#tab-main" class="translate">Allgemein</a></li> <!-- Tab 1 -->
                    <li class="tab col s3"><a href="#tab-filter" class="translate">Parser-Regeln (Filter)</a></li> <!-- Tab 2 -->
                    <li class="tab col s3"><a href="#tab-blacklist" class="translate">Global Blacklist</a></li> <!-- Tab 3 -->
                    <!-- Erweiterte Einstellungen = Advanced Settings -->
                    <li class="tab col s3"><a href="#tab-advanced" class="translate">Erweiterte Einstellungen</a></li> <!-- Tab 4 -->
                </ul>
            </div>

            <!-- Content of the tabs from here -->

            <!-- Tab1 Main-->
            <div id="tab-main" class="col s12 page">            

                <div class="row">
                    <div class="col s12 m4 l2">
                        <img alt="Adapter Logo" src="logparser.png" class="logo">
                    </div>
                </div>

                <!-- Section "Introduction" -->
                <div class="row">
                    <div class="col s12 intro">
                        <h5 class="translate">Adapter: Log Parser</h5>
                        <p><span class="translate">Mit diesem Adapter können die Log-Ausgaben aller Adapter (inkl. der Scripts des JS-Adapters) geparst werden.</span>
                           <span class="translate">Dazu einfach hier in den Einstellungen im Reiter <strong>Parser-Regeln (Filter)</strong> die entsprechenden Regeln hinterlegen. Bei Installation werden bereits mehrere Regeln als Beispiel gesetzt.</span>
                           <span class="translate">Hilfreiche Links:</span>
                        </p>
                        <ul>
                            <li><strong><a href="https://github.com/Mic-M/ioBroker.logparser/blob/master/README.md" target="_blank"><span class="translate">Hilfe und Dokumentation auf Github</span></a></strong></li>
                            <li><strong><a href="https://forum.iobroker.net/topic/31969/" target="_blank"><span class="translate">ioBroker Forum-Artikel zum Parser-Adapter</span></a></strong></li>
                        </ul>
                    </div>
                </div>

                <!-- Section "PID entfernen" -->
                <div class="row">
                    <div class="col s12">
                        <p class="translate title">PID entfernen</p>
                        <p class="translate info">Der js-Controller Version 2.0 oder größer fügt Logs teils vorne die PID in Klammern hinzu, also z.B. "(12234) Terminated: Without reason". Mit dieser Option lassen sich die PIDs inkl. Klammern, wie z.B. "(1234)", aus den Logzeilen entfernen.</p>
                        <div class="input-field col s12 m6">
                            <input type="checkbox" class="value" id="removePid" />
                            <label for="removePid" class="translate">PID entfernen</label>
                        </div>
                    </div>
                </div>

                <!-- Section "Anzahl verwendeter JSON-Tabellen in VIS" -->
                <div class="row">
                    <div class="col s12">
                        <p class="translate title">Anzahl verwendeter JSON-Tabellen in VIS</p>
                        <p class="translate info">Hiermit können zusätzliche Datenpunkte für die Ausgabe als JSON-Tabelle in VIS erzeugt werden, 
                            mit denen es möglich ist, in einer VIS-Tabelle zwischen den einzelnen Filtern umzuschalten 
                            (z.B. 'Homematic', 'Warnungen', 'Fehler' usw.), die dann dynamisch jeweils in dieser einen Tabelle ausgegeben werden.</p>
                        <p class="translate info">Hier die Anzahl der unterschiedlichen JSON-Tabellen angeben, in denen du das brauchst.
                            Diese werden angelegt unter 'visualization.table1', 'visualization.table2', usw.
                            Zum deaktivieren: 0 eintragen (dann werden diese zusätzlichen Datenpunkte nicht erstellt)</p>
                        <div class="input-field col s12 m6">
                            <input class="value validate" placeholder="1" id="visTables" type="number" min="0" max="50">
                            <label for="visTables" class="translate">Für wie viele unterschiedliche JSON-Tabellen benötigst du das?</label>
                            <span class="helper-text translate">Anzahl (0 = deaktiviert)</span>
                        </div>
                    </div>
                </div>


            </div> <!-- end of tab 1-->


            <!-- Tab2 Filter-->
            <div id="tab-filter" class="col s12 page">            

                <div class="row">
                    <div class="col s12 m4 l2">
                        <img alt="Adapter Logo" src="logparser.png" class="logo">
                    </div>
                </div>

                <div class="row">
                    <div class="col s12">
                        <p class="translate title">Filter-Regeln (Log Parser)</p>
                        <p class="translate info">Pro gesetztem Filter (Regel) werden jeweils Datenpunkte unterhalb von 'logparser.[instanz].filters' angelegt.</p>
                        <p class="translate info" style="color:red">Info von Mic: Weitere Infos zum einstellen folgen alsbald!</p>
                        <!-- Start Options Table-->
                        <div class="col s12" id="parserRules">
                            <a class="btn-floating waves-effect waves-light blue table-button-add"><i class="material-icons">add</i></a>
                            <div class="table-values-div">
                                <table class="table-values">
                                    <thead>
                                        <tr>
                                            <th class="header translate" data-name="active" data-type="checkbox">Active?</th>
                                            <th class="header translate" data-name="name">Name</th>
                                            <th class="header translate" data-name="whitelistAnd">Whitelist 1: UND</th>
                                            <th class="header translate" data-name="whitelistOr">Whitelist 2: ODER</th>
                                            <th class="header translate" data-name="blacklist">Blacklist</th>
                                            <th class="header translate" data-name="debug" style="text-align:center" data-type="checkbox">Debug</th>
                                            <th class="header translate" data-name="info" data-type="checkbox">Info</th>
                                            <th class="header translate" data-name="warn" data-type="checkbox">Warn</th>
                                            <th class="header translate" data-name="error" data-type="checkbox">Error</th>
                                            <th class="header translate" data-name="clean">Entferne Teile aus Logzeile</th>
                                            <th class="header translate" data-name="maxLength">Max. Länge</th>
                                            <th class="header translate" data-name="merge" data-type="checkbox">Logs zusammenfassen</th>
                                            <th class="header translate" data-name="dateformat">Datumsformat</th>
                                            <th class="header" data-buttons="up down copy delete"></th>
                                        </tr>
                                    </thead>
                                </table>
                            </div>
                        </div>                        
                        <!-- End Options Table-->
                    </div>
                </div>

                <!-- Section "Datum durch Heute/Gestern ersetzen" -->
                <div class="row">
                    <div class="col s12">
                        <p class="translate title">Datum durch "Heute" / "Gestern" ersetzen</p>
                        <p class="translate info">In den Filtern kann beim Datumsformat für mittels Hash-Zeichen (#) das heutige bzw. gestrige Datum durch 'Heute' bzw. 'Gestern' ersetzt werden. Hier können andere Begriffe statt "Heute"/"Gestern" definiert werden.</p>
                        <div class="input-field col s12 m6">
                            <input type="text" class="value" id="txtToday" />
                            <label for="txtToday" class="translate">Text für Heute</label>
                            <span class="helper-text translate">Ausgabe für "Heute"</span>
                        </div>
                        <div class="input-field col s12 m6">
                            <input type="text" class="value" id="txtYesterday" />
                            <label for="txtYesterday" class="translate">Text für Gestern</label>
                            <span class="helper-text translate">Ausgabe für "Gestern"</span>
                        </div>
                    </div>
                </div>

                <!-- Section "Merge Text" -->
                <div class="row">
                    <div class="col s12">
                        <p class="translate title">Text bei "Logs zusammenfassen"</p>
                        <p class="translate info">Dieser Text wird jeder Logzeile vorangestellt, wenn "Logs zusammenfassen" aktiviert ist. Das #-Zeichen wird dabei dann durch die Anzahl der Logs mit dem gleichen Inhalt ersetzt.</p>
                        <p class="translate info">Sonderzeichen wie [](){}/\ etc. sind erlaubt. Vorschläge: (ohne Anführungszeichen): "[# Einträge] ", "(#) ", "# Einträge: "</p>

                        <div class="input-field col s12 m6">
                            <input type="text" class="value" id="txtMerge" />
                            <label for="txtMerge" class="translate">Text</label>
                            <span class="helper-text translate">Vorangestellter Text (# wird durch Anzahl ersetzt)</span>
                        </div>
                    </div>
                </div>    


            </div> <!-- end of tab 2-->


            <!-- Tab3 Blacklist -->
            <div id="tab-blacklist" class="col s12 page">            

                <div class="row">
                    <div class="col s12 m4 l2">
                        <img alt="Adapter Logo" src="logparser.png" class="logo">
                    </div>
                </div>

                <div class="row">
                    <div class="col s12">
                        <p class="translate title">Globale Blacklist</p>
                        <p class="translate info">Falls einer dieser Satzteile/Begriffe in einer Logzeile enthalten ist, dann wird der Log-Eintrag von diesem Adapter ignoriert, auch unabhängig davon, was in den Parser-Regeln (Filter) eingestellt ist. Es ist sowohl String als auch Regex erlaubt. Falls String: es wird auf teilweise Übereinstimmung geprüft, d.h. wenn du z.B. „echo“ einträgst, dann wird jede Logzeile, die „echo“ enthält, ausgefiltert, also auch z.B. „Command sent to echo in kitchen.“</p>
                        <p class="translate info">Regex bitte zwischen "/" und "/" setzen, damit erkennt der Adapter, ob es sich um eine Regexp handelt.</p>
                        <p class="translate info">In der Spalte "Kommentar" kannst du beliebig den jeweiligen Eintrag kommentieren/erklären, etwa damit du später nachvollziehen kannst, warum du diesen Blacklist-Eintrag gesetzt hast.</p>
                        
                        <!-- Start Options Table-->
                        <div class="col s12" id="globalBlacklist">
                            <a class="btn-floating waves-effect waves-light blue table-button-add"><i class="material-icons">add</i></a>
                            <div class="table-values-div">
                                <table class="table-values">
                                    <thead>
                                        <tr>
                                            <th class="header translate" data-name="active" data-type="checkbox">Active?</th>
                                            <th class="header translate" data-name="item">Blacklist Item</th>
                                            <th class="header translate" data-name="comment">Kommentar</th>
                                            <th class="header" data-buttons="up down copy delete"></th>
                                        </tr>
                                    </thead>
                                </table>
                            </div>
                        </div>                        
                        <!-- End Options Table-->
                    </div>
                </div>

            </div> <!-- end of tab 3-->

            <!-- Tab4 Advanced-->
            <div id="tab-advanced" class="col s12 page">            

                <div class="row">
                    <div class="col s12 m4 l2">
                        <img alt="Adapter Logo" src="logparser.png" class="logo">
                    </div>
                </div>

                <!-- Section "Update Interval" -->
                <div class="row">
                    <div class="col s12">
                        <p class="translate title">Update-Interval: Update data points</p>
                        <p class="translate info">Newly arriving log entries are collected and regularly written to the data points. The default is 10 seconds.</p>
                        <p class="translate info">Note: The data points are only written if there has been a change. Nevertheless, from a performance point of view, it does not make sense to set an interval that is too short. Less than 2 seconds is not allowed.</p>
                        <div class="input-field col s12 m6">
                            <input class="value validate" placeholder="10" id="updateInterval" type="number" min="2" max="10000">
                            <label for="updateInterval" class="translate">Update Interval</label>
                            <span class="helper-text translate">Seconds</span>
                        </div>


                    </div>
                </div>

                <!-- Section "Max Log Entries" -->
                <div class="row">
                    <div class="col s12">
                        <p class="translate title">Maximale Anzahl Logeinträge</p>
                        <p class="translate info">Die maximale Anzahl an Logeinträgen, die in den Datenpunkten behalten werden (ältere werden entfernt). Bitte keine zu hohe Anzahl, je größer, desto mehr Auslastung für den Adapter und damit deinen ioBroker-Server. Eine Zahl von 100 hat sich gut bewährt.</p>
                        <div class="input-field col s12 m6">
                            <input class="value validate" placeholder="100" id="maxLogs" type="number" min="1" max="1000">
                            <label for="maxLogs" class="translate">Maximale Anzahl Logeinträge</label>
                            <span class="helper-text translate">Anzahl</span>
                        </div>
                    </div>
                </div>

                <!-- Section "JSON Table Columns" -->
                <div class="row">
                    <div class="col s12">
                        <p class="translate title">Spalten-Reihenfolge für JSON-Tabelle</p>
                        <p class="translate info">Hier kann die Reihenfolge der einzelnen Spalten verändert werden. Als zusätzliche Spalte wird immer ts (timestamp) hinzugefügt. In VIS usw. bei Bedarf einfach ausblenden.</p>
                        <p class="translate info">Falls du weniger als 4 Spalten brauchst: Wähle einfach einen Eintrag der ersten Spalten aus, die du brauchst, und blende den Rest dann mit dem VIS JSON-Table-Widget (o.ä.) aus.</p>
                        <div class="input-field col s12 m6">
                            <select id="jsonColumns" class="value">
                                <option value="date,severity,from,message">date, severity, from, message</option>
                                <option value="date,from,severity,message">date, from, severity, message</option>
                                <option value="date,from,message,severity">date, from, message, severity</option>
                                <option value="date,message,from,severity">date, message, from, severity</option>
                                <option value="date,message,severity,from">date, message, severity, from</option>
                                <option value="date,severity,message,from">date, severity, message, from</option>
                                <option value="from,date,message,severity">from, date, message, severity</option>
                                <option value="from,date,severity,message">from, date, severity, message</option>
                                <option value="from,message,date,severity">from, message, date, severity</option>
                                <option value="from,message,severity,date">from, message, severity, date</option>
                                <option value="from,severity,date,message">from, severity, date, message</option>
                                <option value="from,severity,message,date">from, severity, message, date</option>
                                <option value="message,date,from,severity">message, date, from, severity</option>
                                <option value="message,date,severity,from">message, date, severity, from</option>
                                <option value="message,from,date,severity">message, from, date, severity</option>
                                <option value="message,from,severity,date">message, from, severity, date</option>
                                <option value="message,severity,date,from">message, severity, date, from</option>
                                <option value="message,severity,from,date">message, severity, from, date</option>
                                <option value="severity,date,from,message">severity, date, from, message</option>
                                <option value="severity,date,message,from">severity, date, message, from</option>
                                <option value="severity,from,date,message">severity, from, date, message</option>
                                <option value="severity,from,message,date">severity, from, message, date</option>
                                <option value="severity,message,date,from">severity, message, date, from</option>
                                <option value="severity,message,from,date">severity, message, from, date</option>
                            </select>
                            <label for="jsonColumns" class="translate">Spalten für JSON-Tabelle</label>
                            <span class="helper-text translate">Entsprechend auswählen</span>
                        </div>
                    </div>
                </div>

                <!-- Section "Sort Descending" -->
                <div class="row">
                    <div class="col s12">
                        <p class="translate title">Sortierung</p>
                        <p class="translate info">Wenn aktiviert: sortiert die Logeinträge absteigend, also neuester oben. Wenn deaktiviert: Sortiert die Logeinträge aufsteigend, also ältester oben.</p>
                        <p class="translate info">Empfohlen ist absteigende Sortierung, also diese Option aktivieren.</p>
                        <div class="input-field col s12 m6">
                            <input type="checkbox" class="value" id="sortDescending" />
                            <label for="sortDescending" class="translate">Absteigend sortieren (neuester oben)</label>
                        </div>
                    </div>
                </div>

            </div> <!-- end of tab 4-->            

        </div> <!-- class "row" -->

    </div> <!-- class "m adapter-container" -->

</body>

</html>